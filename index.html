<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Eurojackpot Helper</title>

<style>
:root{
  --bg:#0f1220; --panel:#171a2a; --muted:#9aa3b2; --text:#e9edf5; --accent:#5f8cff; --ok:#3ddc97;
  --border:#23263a;
}
*{box-sizing:border-box}
body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
.app{max-width:980px; margin:24px auto; padding:0 16px;}
header{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px}
h1{margin:0 0 6px}
.note{color:var(--muted); margin:0 0 8px}
section{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0}
.hidden{display:none}
input,select,button{font:inherit}
input,select{background:#0f1326; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px}
button{background:var(--accent); color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer}
button:disabled{opacity:.6; cursor:not-allowed}
button.ghost{background:transparent; border:1px solid var(--border); color:#cfe0ff}
.row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.banner{margin-top:8px; padding:10px; border-radius:8px; background:#2a2131; border:1px solid #5d254f; color:#ffd5e5}
.banner.ok{background:#1c2b24; border-color:#2f6b4e; color:#c1f1db}

.tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
.tab{background:#1a1f35; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer}
.tab.active{background:#24305a; border-color:#2f3b72}
.tabpanel{margin-top:6px}
.tabpanel.hidden{display:none}

.card{border:1px solid var(--border); border-radius:10px; padding:10px; margin:10px 0; background:#14182b}
.badge{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#1a1f35; color:#dfe6ff; margin-left:6px}
.badge.ok{background:#11261d; color:#bdf7d2; border-color:#1b4b37}
.nums{font-variant-numeric: tabular-nums}

fieldset{border:1px solid #24305a; border-radius:8px; padding:8px}
legend{color:#dfe6ff; font-size:0.9em}
.year-list label{display:inline-flex; gap:6px; align-items:center; background:#10152a; border:1px solid var(--border); padding:6px 10px; border-radius:999px; margin:4px}

.detailsBtn{font-size:12px; color:#a7c1ff; cursor:pointer; text-decoration:underline; margin-left:8px}
.details{display:none; font-size:13px; color:#d8def7; margin-top:6px; line-height:1.35}
.btnrow{display:flex; gap:10px; margin-bottom:10px}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <h1>üéØ Eurojackpot Helper</h1>
    <p class="note">Lokal im Browser. Lade dein Excel-Archiv (.xls/.xlsx). Cut-off: Di/Fr 22:00 Uhr.</p>

    <div class="row">
      <input type="file" id="fileInput" accept=".xls,.xlsx" />
      <button id="btnReload" class="ghost">Neu laden</button>
    </div>
    <div id="freshnessBanner" class="banner hidden"></div>
    <div id="archiveInfo" class="note">Noch kein Archiv geladen.</div>
  </header>

  <section>
    <h2>Modus w√§hlen</h2>
    <div class="tabs">
      <button class="tab active" data-tab="never">Noch nie gesehen</button>
      <button class="tab" data-tab="pairs">H√§ufige Paare</button>
      <button class="tab" data-tab="top">Wahrscheinlichster Schein</button>
    </div>

    <div class="tabpanel" id="tab-never">
      <div class="row">
        <label>Felder:
          <input type="number" id="neverCount" min="1" max="20" value="6">
        </label>
      </div>
      <button id="btnNever">‚ú® Generieren</button>
    </div>

    <div class="tabpanel hidden" id="tab-pairs">
      <div class="row">
        <label>Erzwinge ‚â• k Paare:
          <select id="pairsK">
            <option value="2" selected>2 Paare</option>
            <option value="3">3 Paare</option>
            <option value="4">4 Paare</option>
          </select>
        </label>
        <label>Top-N Paare (Quelle):
          <select id="pairsTopN">
            <option>25</option><option selected>50</option><option>100</option>
          </select>
        </label>
        <label>Felder:
          <input type="number" id="pairsCount" min="1" max="20" value="6">
        </label>
      </div>
      <fieldset>
        <legend>Jahre filtern (optional):</legend>
        <label><input type="checkbox" id="pairsAllYears" checked> Alle Jahre</label>
        <div id="pairsYearList" class="year-list"></div>
      </fieldset>
      <button id="btnPairs">üß© Generieren</button>
    </div>

    <div class="tabpanel hidden" id="tab-top">
      <div class="row">
        <label>Anzahl Felder:
          <input type="number" id="topCount" min="1" max="20" value="10">
        </label>
      </div>
      <fieldset>
        <legend>Jahre filtern (optional):</legend>
        <label><input type="checkbox" id="topAllYears" checked> Alle Jahre</label>
        <div id="topYearList" class="year-list"></div>
      </fieldset>
      <button id="btnTop">‚≠ê Generieren</button>
      <p class="note">Hinweis: rechnerische Empfehlung ‚Äì keine Gewinn-Garantie.</p>
    </div>
  </section>

  <section>
    <h2>Ergebnisse</h2>
    <div class="btnrow">
      <button id="btnExportCSV" class="ghost" disabled>‚¨áÔ∏è Export (CSV)</button>
      <button id="btnExportXLSX" class="ghost" disabled>‚¨áÔ∏è Export (Excel)</button>
    </div>
    <div id="results"></div>
  </section>
</div>
<script>
const DRAW_CUTOFF_H = 22, DRAW_CUTOFF_M = 0; // Di/Fr 22:00

let ARCHIVE = [];          
let SEEN = new Set();
let MAIN_FREQ = Array(51).fill(0);
let EURO_FREQ = Array(13).fill(0);
let LAST_EXPORT = null;

document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.add('hidden'));
    document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
  });
});

document.getElementById('btnReload').addEventListener('click', ()=> location.reload());

document.getElementById('fileInput').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    let rows = [];
    wb.SheetNames.forEach(sn=>{
      const sheet = wb.Sheets[sn];
      if(!sheet) return;
      rows.push(...XLSX.utils.sheet_to_json(sheet, { defval:"" }));
    });
    ARCHIVE = normalizeRows(rows).sort((a,b)=>a.date-b.date);
    if(!ARCHIVE.length){
      const hdr = Object.keys(rows[0]||{}).join(' | ');
      alert('Keine Ziehungen erkannt. Pr√ºfe Spaltennamen.\nErkannte Header:\n'+hdr);
      return;
    }
    buildIndexes();
    fillYearLists();
    showFreshnessBanner();
    renderInfo(`Archiv geladen: ${ARCHIVE.length} Ziehungen.`);
    document.getElementById('results').innerHTML='';
    LAST_EXPORT = null; toggleExport(false);
  }catch(err){
    console.error(err);
    alert('Fehler beim Einlesen: '+(err.message||err));
  }
});

function normalizeRows(rows){
  const out = [];
  const cols = Object.keys(rows[0]||{}).map(c=>String(c).trim());
  const low = cols.map(c=>c.toLowerCase());
  const findCol = (cands)=>{
    for(const c of cands){
      const i = low.indexOf(String(c).toLowerCase());
      if(i>=0) return cols[i];
    }
    for(const c of cands){
      const i = low.findIndex(x=> x.includes(String(c).toLowerCase()));
      if(i>=0) return cols[i];
    }
    return null;
  };
  const colDate = findCol(['Datum','Date','Ziehungsdatum','Ziehung','Datum der Ziehung']);
  let mainColsA = null;
  const patternsA = [
    ['Zahl 1','Zahl 2','Zahl 3','Zahl 4','Zahl 5'],
    ['Zahl1','Zahl2','Zahl3','Zahl4','Zahl5'],
    ['N1','N2','N3','N4','N5']
  ];
  for(const p of patternsA){
    const got = p.map(s=>findCol([s]));
    if(got.every(Boolean)){ mainColsA = got; break; }
  }
  const euroA1 = findCol(['Eurozahl 1','Euro 1','E1','Euro1']);
  const euroA2 = findCol(['Eurozahl 2','Euro 2','E2','Euro2']);
  const packedMain = findCol(['5 aus 50','5aus50','5 aus50','5aus 50']);
  const packedEuro = findCol(['EZ','Euro','Eurozahlen']);
  const idxMain = packedMain ? cols.indexOf(packedMain) : -1;
  const idxEuro = packedEuro ? cols.indexOf(packedEuro) : -1;
  const neighMain = (idxMain>=0 && idxMain+4<cols.length) ? cols.slice(idxMain, idxMain+5) : null;
  const neighEuro = (idxEuro>=0 && idxEuro+1<cols.length) ? cols.slice(idxEuro, idxEuro+2) : null;

  for(const r of rows){
    const dt = parseDateLoose(r[colDate]); if(!dt) continue;
    let main=[], euro=[];
    if(neighMain && neighEuro){
      main = neighMain.map(c=> firstInt(r[c])).filter(isInt);
      euro = neighEuro.map(c=> firstInt(r[c])).filter(isInt);
    }else if(packedMain && packedEuro){
      main = splitNums(r[packedMain]).slice(0,5);
      euro = splitNums(r[packedEuro]).slice(0,2);
    }else if(mainColsA && euroA1 && euroA2){
      main = mainColsA.map(c=> firstInt(r[c])).filter(isInt);
      euro = [firstInt(r[euroA1]), firstInt(r[euroA2])].filter(isInt);
    }
    if(main.length===5 && euro.length===2
      && main.every(n=>n>=1&&n<=50)
      && euro.every(n=>n>=1&&n<=12)){
      main.sort((a,b)=>a-b); euro.sort((a,b)=>a-b);
      out.push({date: dt, main, euro});
    }
  }
  return out;
}

function parseDateLoose(v){
  const s = String(v??'').trim(); if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
  if(/^\d{2}\.\d{2}\.\d{4}/.test(s)){ const [d,m,y]=s.split('.').map(Number); return new Date(y,m-1,d); }
  const t = Date.parse(s); return Number.isNaN(t)?null:new Date(t);
}
function firstInt(val){
  const m = String(val??'').match(/\d+/); return m? parseInt(m[0],10) : NaN;
}
function splitNums(val){
  return String(val??'').split(/[^0-9]+/).map(v=>parseInt(v,10)).filter(Number.isInteger);
}
const isInt = n=> Number.isInteger(n);

function showFreshnessBanner(){
  const b = document.getElementById('freshnessBanner');
  if(!ARCHIVE.length){ b.classList.add('hidden'); return; }
  const latest = ARCHIVE[ARCHIVE.length-1].date;
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const cutoff = new Date(today); cutoff.setHours(DRAW_CUTOFF_H, DRAW_CUTOFF_M, 0, 0);
  const wd = today.getDay();
  const isDrawDay = (wd===2 || wd===5);
  if(isDrawDay && now < cutoff){
    b.textContent = `‚ÑπÔ∏è Heute ist Ziehungstag ‚Äì vor ${DRAW_CUTOFF_H}:00 keine Aktualisierung erwartet. Letzte im Archiv: ${latest.toLocaleDateString('de-DE')}.`;
    b.className = 'banner ok';
  }else if(latest < today){
    b.textContent = `‚ö†Ô∏è Letzte Ziehung im Archiv: ${latest.toLocaleDateString('de-DE')}. Bitte aktuelles Archiv hochladen.`;
    b.className = 'banner';
  }else{
    b.textContent = `‚úÖ Archiv aktuell bis ${latest.toLocaleDateString('de-DE')}.`;
    b.className = 'banner ok';
  }
  b.classList.remove('hidden');
  const a = document.getElementById('archiveInfo');
  a.textContent = `Zeitraum: ${ARCHIVE[0].date.toLocaleDateString('de-DE')} ‚Äì ${latest.toLocaleDateString('de-DE')} ‚Ä¢ ${ARCHIVE.length} Ziehungen`;
}

function buildIndexes(){
  SEEN = new Set(); MAIN_FREQ = Array(51).fill(0); EURO_FREQ = Array(13).fill(0);
  for(const rec of ARCHIVE){
    const {main,euro} = rec;
    SEEN.add(keyCombo(main,euro));
    main.forEach(n=> MAIN_FREQ[n]++);
    euro.forEach(n=> EURO_FREQ[n]++);
  }
}

function fillYearLists(){
  const years = Array.from(new Set(ARCHIVE.map(x=>x.date.getFullYear()))).sort((a,b)=>a-b);
  const pairs = document.getElementById('pairsYearList'); pairs.innerHTML='';
  const top = document.getElementById('topYearList'); top.innerHTML='';
  years.forEach(y=>{
    pairs.insertAdjacentHTML('beforeend', `<label><input type="checkbox" value="${y}" checked> ${y}</label>`);
    top.insertAdjacentHTML('beforeend', `<label><input type="checkbox" value="${y}" checked> ${y}</label>`);
  });
  document.getElementById('pairsAllYears').onchange = e=>{
    pairs.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.checked = e.target.checked);
  };
  document.getElementById('topAllYears').onchange = e=>{
    top.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.checked = e.target.checked);
  };
}

const byNumAsc = (a,b)=>a-b;
function keyCombo(m,e){ return m.join('-')+'|'+e.join('-'); }
function renderInfo(msg){
  const r = document.getElementById('results');
  const div = document.createElement('div'); div.className='card'; div.textContent = msg; r.prepend(div);
}
function toggleExport(on){
  document.getElementById('btnExportCSV').disabled = !on;
  document.getElementById('btnExportXLSX').disabled = !on;
}
/* ======= Noch nie gesehen ======= */
document.getElementById('btnNever').addEventListener('click', ()=>{
  if(!ARCHIVE.length) return alert('Bitte zuerst Archiv laden.');
  const count = parseInt(document.getElementById('neverCount').value,10);
  const res = [];
  while(res.length<count){
    const main = pickUniqueNums(5,1,50);
    const euro = pickUniqueNums(2,1,12);
    if(!SEEN.has(keyCombo(main,euro))){
      res.push({main,euro});
    }
  }
  showResults(res,'Noch nie gesehen');
});

/* ======= H√§ufige Paare ======= */
document.getElementById('btnPairs').addEventListener('click', ()=>{
  if(!ARCHIVE.length) return alert('Bitte zuerst Archiv laden.');
  const k = parseInt(document.getElementById('pairsK').value,10);
  const topN = parseInt(document.getElementById('pairsTopN').value,10);
  const count = parseInt(document.getElementById('pairsCount').value,10);
  const years = getSelectedYears('pairsYearList','pairsAllYears');
  const subset = ARCHIVE.filter(r=> years.has(r.date.getFullYear()));
  const pairCounts = new Map();
  for(const rec of subset){
    const nums = rec.main;
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const key = nums[i]+'-'+nums[j];
        pairCounts.set(key, (pairCounts.get(key)||0)+1);
      }
    }
  }
  const topPairs = Array.from(pairCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,topN).map(e=>e[0].split('-').map(Number));
  const res=[];
  while(res.length<count){
    const main = pickUniqueNums(5,1,50);
    const matchPairs = topPairs.filter(p=> main.includes(p[0]) && main.includes(p[1]));
    if(matchPairs.length>=k) res.push({main:main.sort(byNumAsc), euro:pickUniqueNums(2,1,12)});
  }
  showResults(res,`H√§ufige Paare ‚â•${k} (Top ${topN})`);
});

/* ======= Wahrscheinlichster Schein ======= */
document.getElementById('btnTop').addEventListener('click', ()=>{
  if(!ARCHIVE.length) return alert('Bitte zuerst Archiv laden.');
  const count = parseInt(document.getElementById('topCount').value,10);
  const years = getSelectedYears('topYearList','topAllYears');
  const subset = ARCHIVE.filter(r=> years.has(r.date.getFullYear()));
  const freqMain = Array(51).fill(0), freqEuro = Array(13).fill(0);
  for(const rec of subset){
    rec.main.forEach(n=> freqMain[n]++);
    rec.euro.forEach(n=> freqEuro[n]++);
  }
  const scored=[];
  for(let i=1;i<=50;i++) for(let j=i+1;j<=50;j++) for(let k=j+1;k<=50;k++) for(let l=k+1;l<=50;l++) for(let m=l+1;m<=50;m++){
    const main=[i,j,k,l,m];
    const euro=pickUniqueNums(2,1,12);
    const score= main.reduce((s,n)=>s+freqMain[n],0)+ euro.reduce((s,n)=>s+freqEuro[n],0);
    scored.push({main,euro,score});
    if(scored.length>5000) break;
  }
  scored.sort((a,b)=>b.score-a.score);
  showResults(scored.slice(0,count),'Wahrscheinlichster Schein',true);
});

/* ======= Helpers ======= */
function pickUniqueNums(n,min,max){
  const nums=[]; while(nums.length<n){
    const r = Math.floor(Math.random()*(max-min+1))+min;
    if(!nums.includes(r)) nums.push(r);
  }
  return nums;
}
function getSelectedYears(listId,allId){
  if(document.getElementById(allId).checked) return new Set(ARCHIVE.map(r=>r.date.getFullYear()));
  return new Set(Array.from(document.getElementById(listId).querySelectorAll('input:checked')).map(cb=>parseInt(cb.value,10)));
}
function showResults(arr,title,withScore=false){
  const r = document.getElementById('results');
  r.innerHTML='';
  LAST_EXPORT = arr.map(o=>({main:o.main.join(','), euro:o.euro.join(','), score:o.score||''}));
  toggleExport(true);
  arr.forEach(o=>{
    const card=document.createElement('div'); card.className='card';
    const mainSpan=`<span class="nums">${o.main.join(' ')}</span>`;
    const euroSpan=`<span class="nums">${o.euro.join(' ')}</span>`;
    card.innerHTML=`<b>${title}</b><br>Main: ${mainSpan} <span class="badge">Euro: ${euroSpan}</span>`+(withScore?`<span class="badge ok">${o.score} Punkte</span>`:'');
    r.appendChild(card);
  });
}

/* ======= Export ======= */
document.getElementById('btnExportCSV').addEventListener('click', ()=>{
  if(!LAST_EXPORT) return;
  const rows=[Object.keys(LAST_EXPORT[0])].concat(LAST_EXPORT.map(o=>Object.values(o)));
  const csv=rows.map(r=>r.join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ergebnisse.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
document.getElementById('btnExportXLSX').addEventListener('click', ()=>{
  if(!LAST_EXPORT) return;
  const ws=XLSX.utils.json_to_sheet(LAST_EXPORT);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Ergebnisse');
  XLSX.writeFile(wb,'ergebnisse.xlsx');
});
</script>
</body>
</html>
