<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Eurojackpot Tipps ‚Äì Generator</title>
<style>
  :root { --bg:#0f1220; --fg:#e9ecf1; --muted:#9aa4b2; --card:#171b30; --acc:#5dd6a9; --bad:#ff8585; --btn:#2a3356; --line:#1f2746; }
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:5;background:#0c0f1a;border-bottom:1px solid var(--line)}
  .bar{padding:14px 16px;display:flex;align-items:center;gap:10px}
  .brand{font-weight:800;font-size:18px}
  main{padding:14px;max-width:820px;margin:0 auto;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid #242b4a;border-radius:14px;padding:14px}
  .card h2{margin:0 0 8px 0;font-size:16px}
  .muted{color:var(--muted)}
  .bad{color:var(--bad)}
  .ok{color:var(--acc)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .stack{display:grid;gap:10px}
  input,button{background:#0e1330;color:var(--fg);border:1px solid #2c3761;border-radius:12px;padding:12px 14px;font:inherit}
  input[type="number"]{width:100px;text-align:center}
  button{background:var(--btn);cursor:pointer}
  button.primary{background:var(--acc);color:#0b1320;border:none}
  .btn-wide{width:100%}
  .nums{display:flex;flex-wrap:wrap;gap:6px}
  .num{min-width:28px;text-align:center;padding:6px 10px;border-radius:10px;background:#0e1433;border:1px solid #2a345e}
  .num.euro{border-color:#5d74d6}
  .tile{background:#101630;border:1px solid #25315d;border-radius:12px;padding:12px}
  .sep{height:1px;background:#25315d;margin:6px 0}
  .tagbar{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .tag{background:#111736;border:1px solid #2a3560;border-radius:12px;padding:10px;text-align:center;font-weight:600}
  .tag.active{background:#27335f}
</style>
</head>
<body>
<header><div class="bar"><div class="brand">üéØ Eurojackpot Tipps</div></div></header>

<main>
  <!-- Archiv / Kopf -->
  <section class="card stack">
    <div class="muted">Lokal im Browser. Lade dein Archiv (.txt/.csv/.tsv). Cut-off: Di/Fr 22:00 Uhr.</div>
    <div class="row">
      <input id="file" class="btn-wide" type="file" accept=".txt,.csv,.tsv">
      <button id="btnImport" class="primary" style="flex:1">Datei importieren</button>
    </div>
    <div class="row">
      <button id="btnReload" style="flex:1">Neu laden</button>
      <button id="btnExport" style="flex:1">Archiv exportieren</button>
      <button id="btnClear" style="flex:1">Archiv l√∂schen</button>
    </div>
    <div id="freshWarn" class="tile" style="display:none"></div>
    <div class="muted" id="archInfo">(leer)</div>
  </section>

  <!-- Modus -->
  <section class="card">
    <h2>Modus</h2>
    <div class="tagbar" id="modes">
      <div class="tag active" data-mode="never">Noch nie gesehen</div>
      <div class="tag" data-mode="likely">Wahrscheinlichster Schein (Muster)</div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <label class="muted">Felder:</label>
      <input id="genCount" type="number" min="1" max="50" value="6">
      <button id="btnGenerate" class="primary" style="flex:1">‚ú® Generieren</button>
    </div>
    <div class="muted">Eurozahlen werden f√ºr jedes Feld <b>zuf√§llig</b> gew√§hlt (2 aus 1‚Äì12, verschieden).</div>
  </section>

  <!-- Gespeicherte Tipps -->
  <section class="card stack">
    <h2>Gespeicherte Tipps</h2>
    <div class="row">
      <button id="btnExportTips" style="flex:1">Tipps exportieren (CSV)</button>
      <button id="btnClearTips" style="flex:1">Alle Tipps l√∂schen</button>
    </div>
    <div id="tipsList" class="stack"></div>
  </section>
</main>

<script>
/* ========= Helpers & Storage ========= */
const by=id=>document.getElementById(id);
const LS_KEY='ej_archive_v1', LS_TIPS='ej_tips_v1';
const cmp=(a,b)=>a-b, sum=a=>a.reduce((x,y)=>x+y,0);
const setKey5=a=>a.slice().sort(cmp).join('-');
function loadArchive(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch(e){return[]} }
function saveArchive(a){ localStorage.setItem(LS_KEY, JSON.stringify(a.sort((x,y)=>x.date.localeCompare(y.date)))); renderHeader(); }
function loadTips(){ try{return JSON.parse(localStorage.getItem(LS_TIPS)||'[]')}catch(e){return[]} }
function saveTips(t){ localStorage.setItem(LS_TIPS, JSON.stringify(t)); renderTips(); }

/* ========= Parsing Archiv (Tag,Monat,Jahr,A1..A5,B1,B2) ========= */
function parseRowTokens(t){
  if(t.length<9) return null;
  const [tag,mon,yr,...r]=t.map(s=>String(s).trim());
  const A=r.slice(0,5).map(Number);
  const B=r.slice(5,7).map(Number).filter(n=>!isNaN(n));
  if([tag,mon,yr].some(x=>isNaN(+x))||A.some(isNaN)) return null;
  const yyyy=+yr, mm=String(+mon).padStart(2,'0'), dd=String(+tag).padStart(2,'0');
  return {date:`${yyyy}-${mm}-${dd}`, main:A.sort(cmp), euro:B.sort(cmp)};
}
function parseTSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim()); const out=[];
  for(let i=0;i<lines.length;i++){
    const parts=lines[i].split(/\t|;|,/);
    if(i===0 && /Tag/i.test(parts[0])) continue;
    const row=parseRowTokens(parts); if(row) out.push(row);
  }
  return out;
}
function mergeArchive(items){
  const arch=loadArchive(); const seen=new Set(arch.map(d=>d.date)); let added=0;
  for(const it of items){ if(!seen.has(it.date)){ arch.push(it); seen.add(it.date); added++; } }
  saveArchive(arch); return {added,total:arch.length};
}

/* ========= Grund-Statistik ========= */
function freqMain(arch){ const f=Array(51).fill(0); arch.forEach(d=>d.main.forEach(n=>f[n]++)); return f; }
function lastSeenMap(arch){
  const m=new Map();
  for(let i=arch.length-1;i>=0;i--) arch[i].main.forEach(n=>{ if(!m.has(n)) m.set(n, arch.length-1-i); });
  return m;
}
function existingMainSetKeys(arch){ const s=new Set(); arch.forEach(d=>s.add(setKey5(d.main))); return s; }
function patternFeatures(main){
  const s=main.slice().sort(cmp);
  const gaps=[s[1]-s[0],s[2]-s[1],s[3]-s[2],s[4]-s[3]];
  const consec=(s[1]===s[0]+1)+(s[2]===s[1]+1)+(s[3]===s[2]+1)+(s[4]===s[3]+1);
  const evens=s.filter(x=>x%2===0).length;
  return {gaps,sum:sum(s),consec,evens};
}
function archiveShape(arch){
  // Mittelwerte & Modus der Muster √ºber das Archiv
  const sums=[], evs=[], cons=[], gaps=[];
  const gapMap=new Map();
  arch.forEach(d=>{
    const f=patternFeatures(d.main);
    sums.push(f.sum); evs.push(f.evens); cons.push(f.consec);
    const gk=f.gaps.join('-'); gapMap.set(gk,(gapMap.get(gk)||0)+1);
  });
  const avg = a => a.reduce((x,y)=>x+y,0)/a.length;
  const modeGap = Array.from(gapMap.entries()).sort((a,b)=>b[1]-a[1])[0]?.[0]||'';
  return {
    avgSum: avg(sums), avgEven: avg(evs), avgConsec: avg(cons),
    modeGaps: modeGap.split('-').map(Number)
  };
}

/* ========= Header / Aktualit√§t ========= */
function expectedLastDateISO(){
  const now=new Date(); const day=now.getDay();
  function lastDow(to){ const d=new Date(now); d.setHours(22,0,0,0); const diff=(day-to+7)%7; d.setDate(d.getDate()-diff); return d; }
  let cand=lastDow(5); if(now<cand) cand=lastDow(2); if(now<cand) cand=new Date(cand-5*24*3600*1000);
  return cand.toISOString().slice(0,10);
}
function renderHeader(){
  const arch=loadArchive(); const info=by('archInfo'); const warn=by('freshWarn');
  if(!arch.length){ info.textContent='(aus Speicher) ‚Äì kein Archiv geladen'; warn.style.display='none'; return; }
  const first=arch[0].date, last=arch[arch.length-1].date;
  info.textContent=`Zeitraum: ${first} ‚Äì ${last} ‚Ä¢ ${arch.length} Ziehungen`;
  const exp=expectedLastDateISO();
  if(last<exp){ warn.style.display='block'; warn.innerHTML=`‚ö†Ô∏è <span class="bad">Vermutlich gibt es neuere Ziehungen.</span><br>Letzte im Archiv: <b>${last}</b> | erwartet bis: <b>${exp}</b>.`; }
  else warn.style.display='none';
}

/* ========= Euro: zuf√§llig ========= */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function randomEuroPair(){
  let a=randInt(1,12), b=randInt(1,12);
  while(b===a) b=randInt(1,12);
  return [a,b].sort((x,y)=>x-y);
}

/* ========= Generatoren ========= */
function random5Unique(){ const s=new Set(); while(s.size<5) s.add(randInt(1,50)); return Array.from(s).sort(cmp); }

function genNeverSeen(n){
  const arch=loadArchive(); if(!arch.length) return alert('Bitte zuerst Archiv laden.');
  const seen=existingMainSetKeys(arch);
  const tips=loadTips(); const out=[]; let guard=0;
  while(out.length<n && guard<30000){
    guard++;
    const main=random5Unique();
    const key=setKey5(main);
    if(!seen.has(key)){
      out.push({main, euro:randomEuroPair(), ts:Date.now(), mode:'never'});
      seen.add(key);
    }
  }
  saveTips(tips.concat(out));
}

function scoreCandidate(main, sh, fm, lastMap){
  // Score h√∂her = besser
  const f=patternFeatures(main);
  // 1) H√§ufigkeitssumme
  let freqScore=0; for(const n of main) freqScore += fm[n];
  // 2) Recency: nicht zu frisch, nicht zu alt -> Glocke um Median
  const ls = main.map(n=> lastMap.get(n)??9999);
  const rec = ls.reduce((a,b)=>a+b,0) / ls.length; // kleiner = frischer
  const recScore = -Math.abs(rec - 60); // 60 Ziehungen als ‚Äûsweet spot‚Äú (heuristisch)
  // 3) Summe, Even/Odd, Konsekutive an Archiv-Avg angleichen
  const sSum = -Math.abs(f.sum - sh.avgSum);
  const sEven = -Math.abs(f.evens - sh.avgEven);
  const sCon  = -Math.abs(f.consec - sh.avgConsec);
  // 4) L√ºckenmuster-N√§he (Manhattan)
  const gapD = sh.modeGaps.length===4 ? f.gaps.reduce((acc,v,i)=>acc+Math.abs(v-(sh.modeGaps[i]||0)),0) : 0;
  const sGap = -gapD;
  return freqScore*1.0 + recScore*0.6 + sSum*0.25 + sEven*0.8 + sCon*0.6 + sGap*0.5;
}
function genLikely(n){
  const arch=loadArchive(); if(!arch.length) return alert('Bitte zuerst Archiv laden.');
  const seen=existingMainSetKeys(arch);
  const fm=freqMain(arch), last=lastSeenMap(arch), sh=archiveShape(arch);
  const tips=loadTips(); const out=[];
  // Wir sampeln viele Kandidaten und nehmen die besten
  const pool=[];
  let guard=0;
  while(pool.length<Math.max(200, n*80) && guard<50000){
    guard++;
    const main=random5Unique();
    const key=setKey5(main);
    if(seen.has(key)) continue;
    const sc=scoreCandidate(main, sh, fm, last);
    pool.push({main, score:sc});
  }
  pool.sort((a,b)=>b.score-a.score);
  for(let i=0;i<Math.min(n,pool.length);i++){
    out.push({main:pool[i].main, euro:randomEuroPair(), ts:Date.now(), mode:'likely', score:+pool[i].score.toFixed(2)});
    seen.add(setKey5(pool[i].main));
  }
  saveTips(tips.concat(out));
}

/* ========= UI: Tipps-Liste ========= */
function renderTips(){
  const host=by('tipsList'); host.innerHTML='';
  const tips=loadTips();
  if(!tips.length){ host.innerHTML='<div class="muted">Noch keine Tipps gespeichert.</div>'; return; }
  tips.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='tile';
    const date=new Date(t.ts||Date.now()).toLocaleString();
    row.innerHTML = `
      <div class="row" style="align-items:center">
        <div>#${i+1}</div>
        <div class="nums">
          ${t.main.map(n=>`<span class="num">${n}</span>`).join('')}
          &nbsp;+&nbsp; ${t.euro.map(n=>`<span class="num euro">${n}</span>`).join('')}
        </div>
        <div class="muted" style="margin-left:auto">${t.mode==='likely'?'Muster':'Neu'}${t.score!==undefined?' ¬∑ Score '+t.score:''} ¬∑ ${date}</div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button data-idx="${i}" class="btnDel">L√∂schen</button>
      </div>`;
    host.appendChild(row);
  });
}
by('tipsList').addEventListener('click',e=>{
  const b=e.target.closest('.btnDel'); if(!b) return;
  const i=+b.dataset.idx; const tips=loadTips(); tips.splice(i,1); saveTips(tips);
});
by('btnClearTips').onclick=()=>{ if(confirm('Alle gespeicherten Tipps l√∂schen?')) saveTips([]); };
by('btnExportTips').onclick=()=>{
  const tips=loadTips(); if(!tips.length) return alert('Keine Tipps vorhanden.');
  const lines=['mode,main1,main2,main3,main4,main5,euro1,euro2,score,zeit'];
  for(const t of tips){ lines.push([t.mode,...t.main,...t.euro,(t.score??''), new Date(t.ts||Date.now()).toISOString()].join(',')); }
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eurojackpot_tipps.csv'; a.click();
};

/* ========= UI: Archiv-Buttons ========= */
by('btnImport').onclick=async()=>{
  const f=by('file').files[0]; if(!f) return alert('Bitte eine Datei ausw√§hlen.');
  const text=await f.text(); const rows=parseTSV(text);
  const {added,total}=mergeArchive(rows); renderHeader();
  alert(`Import fertig: ${added} neu. Gesamt: ${total}.`);
};
by('btnReload').onclick=renderHeader;
by('btnExport').onclick=()=>{
  const arch=loadArchive();
  const header=['Tag','Monat','Jahr','ZahlA1','ZahlA2','ZahlA3','ZahlA4','ZahlA5','ZahlB1','ZahlB2'].join('\t');
  const lines=arch.map(d=>{ const [y,m,da]=d.date.split('-').map(x=>+x); return [da,m,y, d.main.join('\t'), (d.euro[0]??''), (d.euro[1]??'')].join('\t'); });
  const blob=new Blob([header+'\n'+lines.join('\n')],{type:'text/tab-separated-values'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eurojackpot_archiv.tsv'; a.click();
};
by('btnClear').onclick=()=>{ if(confirm('Archiv im Browser l√∂schen?')){ localStorage.removeItem(LS_KEY); renderHeader(); } };

/* ========= Modus & Generate ========= */
let currentMode='never';
by('modes').addEventListener('click',e=>{
  const t=e.target.closest('.tag'); if(!t) return;
  by('modes').querySelectorAll('.tag').forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); currentMode=t.dataset.mode;
});
by('btnGenerate').onclick=()=>{
  const n=+by('genCount').value||6;
  if(currentMode==='never') genNeverSeen(n);
  else genLikely(n);
  renderTips();
};

/* ========= Init ========= */
renderHeader();
renderTips();
</script>
</body>
</html>