<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Eurojackpot Helper + Meta & GOAT</title>

<style>
:root{--bg:#0f1220;--panel:#171a2a;--muted:#9aa3b2;--text:#e9edf5;--acc:#5f8cff;--ok:#3ddc97;--bor:#23263a;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
.app{max-width:1000px;margin:24px auto;padding:0 16px}
header,section{background:var(--panel);border:1px solid var(--bor);border-radius:12px;padding:16px;margin:16px 0}
h1{margin:0 0 6px} .muted{color:var(--muted)} .hidden{display:none}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
input,select,button{font:inherit}
input,select{background:#0f1326;color:var(--text);border:1px solid var(--bor);border-radius:8px;padding:10px;min-width:100px}
button{background:var(--acc);color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
button.ghost{background:transparent;border:1px solid var(--bor);color:#cfe0ff}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.tab{background:#1a1f35;border:1px solid var(--bor);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
.tab.active{background:#24305a;border-color:#2f3b72}
.tabpanel{margin-top:6px} .tabpanel.hidden{display:none}
.card{border:1px solid var(--bor);border-radius:10px;padding:10px;margin:10px 0;background:#14182b}
.badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--bor);background:#1a1f35;color:#dfe6ff;margin-left:6px}
.badge.ok{background:#11261d;color:#bdf7d2;border-color:#1b4b37}
.nums{font-variant-numeric:tabular-nums}
fieldset{border:1px solid #24305a;border-radius:8px;padding:8px}
legend{color:#dfe6ff;font-size:.95em}
.year-list{display:flex;flex-wrap:wrap;gap:8px}
.year-list label{display:inline-flex;gap:6px;align-items:center;background:#10152a;border:1px solid var(--bor);padding:6px 10px;border-radius:999px}
.btnrow{display:flex;gap:10px;margin-bottom:10px}
.banner{margin-top:8px;padding:10px;border-radius:8px;background:#2a2131;border:1px solid #5d254f;color:#ffd5e5}
.banner.ok{background:#1c2b24;border-color:#2f6b4e;color:#c1f1db}
.small{font-size:12px;color:#b8c4e6}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <h1>üéØ Eurojackpot Helper</h1>
    <p class="muted">Lokal im Browser. Lade dein Excel-Archiv (.xls/.xlsx). Cut-off: Di/Fr 22:00 Uhr.</p>
    <div class="row">
      <input type="file" id="fileInput" accept=".xls,.xlsx" />
      <button id="btnReload" class="ghost">Neu laden</button>
    </div>
    <div id="freshness" class="banner hidden"></div>
    <div id="archInfo" class="muted">Noch kein Archiv geladen.</div>
  </header>

  <section>
    <h2>Modus w√§hlen</h2>
    <div class="tabs">
      <button class="tab active" data-tab="never">Noch nie gesehen</button>
      <button class="tab" data-tab="pairs">H√§ufige Paare</button>
      <button class="tab" data-tab="top">Wahrscheinlichster Schein</button>
      <button class="tab" data-tab="meta">Meta</button>
      <button class="tab" data-tab="goat">GOAT üêê</button>
    </div>

    <!-- Noch nie gesehen -->
    <div class="tabpanel" id="tab-never">
      <div class="row">
        <label>Felder:
          <input type="number" id="neverCount" min="1" max="20" value="6">
        </label>
      </div>
      <button id="btnNever">‚ú® Generieren</button>
    </div>

    <!-- H√§ufige Paare -->
    <div class="tabpanel hidden" id="tab-pairs">
      <div class="row">
        <label>Erzwinge ‚â• k Paare:
          <select id="pairsK"><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option></select>
        </label>
        <label>Top-N Paare (Quelle):
          <select id="pairsTopN"><option>25</option><option selected>50</option><option>100</option></select>
        </label>
        <label>Felder:
          <input type="number" id="pairsCount" min="1" max="20" value="6">
        </label>
      </div>
      <fieldset>
        <legend>Jahre filtern (optional)</legend>
        <label><input type="checkbox" id="pairsAll" checked> Alle Jahre</label>
        <div id="pairsYears" class="year-list"></div>
      </fieldset>
      <button id="btnPairs">üß© Generieren</button>
    </div>

    <!-- Wahrscheinlichster Schein -->
    <div class="tabpanel hidden" id="tab-top">
      <div class="row">
        <label>Anzahl Felder:
          <input type="number" id="topCount" min="1" max="20" value="10">
        </label>
      </div>
      <fieldset>
        <legend>Jahre filtern (optional)</legend>
        <label><input type="checkbox" id="topAll" checked> Alle Jahre</label>
        <div id="topYears" class="year-list"></div>
      </fieldset>
      <button id="btnTop">‚≠ê Generieren</button>
      <p class="small">Hinweis: rechnerische Empfehlung ‚Äì keine Gewinn-Garantie.</p>
    </div>

    <!-- Meta -->
    <div class="tabpanel hidden" id="tab-meta">
      <div class="row">
        <label>Scheine (1‚Äì10):
          <input type="number" id="metaTickets" min="1" max="10" value="2">
        </label>
        <label>Felder pro Schein (1‚Äì20):
          <input type="number" id="metaFields" min="1" max="20" value="10">
        </label>
        <label><input type="checkbox" id="metaAvoidSeen" checked> Bereits gezogene Komplett-Kombis vermeiden</label>
      </div>
      <button id="btnMeta">üé´ Meta-Scheine generieren</button>
    </div>

    <!-- GOAT -->
    <div class="tabpanel hidden" id="tab-goat">
      <div class="row">
        <label>Felder:
          <input type="number" id="goatCount" min="1" max="20" value="10">
        </label>
        <label>Kandidatenmenge:
          <select id="goatPool"><option value="4000">4k</option><option value="6000" selected>6k</option><option value="10000">10k</option></select>
        </label>
      </div>
      <fieldset>
        <legend>Zeitraum f√ºrs Scoring</legend>
        <label><input type="checkbox" id="goatAll" checked> Alle Jahre</label>
        <div id="goatYears" class="year-list"></div>
      </fieldset>
      <button id="btnGoat">üêê GOAT-Felder erzeugen</button>
      <p class="small">Ensemble-Score aus H√§ufigkeit, Recency, Paar/Tripel, Gaps, Parit√§t, Low/High-Balance, Streuung, Euro-Frequenzen und ‚ÄûSeen‚Äú-Penalty.</p>
    </div>
  </section>

  <section>
    <h2>Ergebnisse</h2>
    <div class="btnrow">
      <button id="btnCSV" class="ghost" disabled>‚¨áÔ∏è Export (CSV)</button>
      <button id="btnXLSX" class="ghost" disabled>‚¨áÔ∏è Export (Excel)</button>
    </div>
    <div id="results"></div>
  </section>
</div>

<script>
/* ====== Global ====== */
const DRAW_CUTOFF_H=22,DRAW_CUTOFF_M=0;
let ARCH=[], SEEN=new Set(), MAIN=Array(51).fill(0), EURO=Array(13).fill(0);
let YEARS=[], LAST_EXPORT=null;

document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.add('hidden'));
    document.getElementById('tab-'+b.dataset.tab).classList.remove('hidden');
  });
});

document.getElementById('btnReload').onclick=()=>location.reload();

/* ====== Upload & Parsing (passt zu deinem XLS) ====== */
document.getElementById('fileInput').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=await f.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'});
    const rows=[]; wb.SheetNames.forEach(sn=>rows.push(...XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:""})));
    ARCH = normalize(rows).sort((a,b)=>a.date-b.date);
    if(!ARCH.length){ alert('Keine Ziehungen erkannt. Erwartet: Spalten ‚ÄûDatum‚Äú, ‚Äû5 aus 50‚Äú, ‚ÄûEZ‚Äú (oder Nachbarspalten).'); return; }
    indexStats(); buildYears(); freshness();
    document.getElementById('archInfo').textContent=`Zeitraum: ${fmtD(ARCH[0].date)} ‚Äì ${fmtD(ARCH[ARCH.length-1].date)} ‚Ä¢ ${ARCH.length} Ziehungen`;
    document.getElementById('results').innerHTML=''; LAST_EXPORT=null; setExport(false);
  }catch(err){ alert('Fehler beim Einlesen: '+(err.message||err)); }
});

function normalize(rows){
  const out=[];
  const cols=Object.keys(rows[0]||{}).map(c=>String(c).trim());
  const low=cols.map(c=>c.toLowerCase());
  const col=(names)=>{for(const n of names){const i=low.indexOf(n.toLowerCase());if(i>=0)return cols[i];}for(const n of names){const j=low.findIndex(x=>x.includes(n.toLowerCase()));if(j>=0)return cols[j];}return null;};
  const cDate=col(['datum','date','ziehung','ziehungsdatum']);
  const cPackedMain=col(['5 aus 50','5aus50','5 aus50']);
  const cPackedEZ=col(['ez','euro','eurozahlen']);
  const idxMain=cols.indexOf(cPackedMain||''); const idxEZ=cols.indexOf(cPackedEZ||'');
  const neighMain=(idxMain>=0 && idxMain+4<cols.length)? cols.slice(idxMain,idxMain+5):null;
  const neighEZ=(idxEZ>=0 && idxEZ+1<cols.length)? cols.slice(idxEZ,idxEZ+2):null;

  rows.forEach(r=>{
    const dt=parseDateLoose(r[cDate]); if(!dt) return;
    let main=[], euro=[];
    if(neighMain && neighEZ){
      main=neighMain.map(c=>firstInt(r[c])).filter(Number.isInteger);
      euro=neighEZ.map(c=>firstInt(r[c])).filter(Number.isInteger);
    }else{
      main=splitNums(r[cPackedMain]).slice(0,5);
      euro=splitNums(r[cPackedEZ]).slice(0,2);
    }
    if(main.length===5 && euro.length===2 && main.every(n=>n>=1&&n<=50) && euro.every(n=>n>=1&&n<=12)){
      main.sort((a,b)=>a-b); euro.sort((a,b)=>a-b); out.push({date:dt, main, euro});
    }
  });
  return out;
}
function parseDateLoose(v){const s=String(v??'').trim();if(!s)return null;if(/^\d{4}-\d{2}-\d{2}/.test(s))return new Date(s);if(/^\d{2}\.\d{2}\.\d{4}/.test(s)){const[d,m,y]=s.split('.').map(Number);return new Date(y,m-1,d);}const t=Date.parse(s);return Number.isNaN(t)?null:new Date(t);}
function splitNums(cell){return String(cell??'').replace(/[^\d]+/g,' ').trim().split(/\s+/).map(x=>parseInt(x,10)).filter(Number.isInteger);}
function firstInt(v){const m=String(v??'').match(/\d+/);return m?parseInt(m[0],10):NaN;}
const byNum=(a,b)=>a-b; const key=(m,e)=>m.join('-')+'|'+e.join('-'); const fmtD=d=>d.toLocaleDateString('de-DE');

/* ====== Indizes, Jahre, Freshness ====== */
function indexStats(){SEEN=new Set(); MAIN=Array(51).fill(0); EURO=Array(13).fill(0); ARCH.forEach(r=>{SEEN.add(key(r.main,r.euro)); r.main.forEach(n=>MAIN[n]++); r.euro.forEach(n=>EURO[n]++);});}
function buildYears(){YEARS=Array.from(new Set(ARCH.map(r=>r.date.getFullYear()))).sort((a,b)=>a-b);
  const fill=(id)=>{const c=document.getElementById(id); c.innerHTML=''; YEARS.forEach(y=>c.insertAdjacentHTML('beforeend',`<label><input type="checkbox" value="${y}" checked> ${y}</label>`));};
  fill('pairsYears'); fill('topYears'); fill('goatYears');
  document.getElementById('pairsAll').onchange=e=>{document.querySelectorAll('#pairsYears input').forEach(cb=>cb.checked=e.target.checked);};
  document.getElementById('topAll').onchange=e=>{document.querySelectorAll('#topYears input').forEach(cb=>cb.checked=e.target.checked);};
  document.getElementById('goatAll').onchange=e=>{document.querySelectorAll('#goatYears input').forEach(cb=>cb.checked=e.target.checked);};
}
function selYears(containerId, allId){if(document.getElementById(allId).checked) return null; return new Set(Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(x=>parseInt(x.value,10)));}
function filterYears(data, yearsSet){if(!yearsSet||!yearsSet.size) return data; return data.filter(r=>yearsSet.has(r.date.getFullYear()));}

function lastExpectedDraw(now=new Date()){
  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const wd=today.getDay(); const cutoff=new Date(today); cutoff.setHours(DRAW_CUTOFF_H,DRAW_CUTOFF_M,0,0);
  const backTo=t=>{const n=(wd-t+7)%7;const d=new Date(today);d.setDate(today.getDate()-n);return d;};
  const tue=backTo(2), fri=backTo(5); let latest=(tue>fri)?tue:fri;
  if((wd===2||wd===5) && now<cutoff){ const prev=new Date(today); prev.setDate(prev.getDate()-(wd===2?4:3)); latest=prev; }
  return latest;
}
function freshness(){
  const b=document.getElementById('freshness'); if(!ARCH.length){b.classList.add('hidden');return;}
  const latest=ARCH[ARCH.length-1].date; const exp=lastExpectedDraw(new Date());
  if(new Date(latest.getFullYear(),latest.getMonth(),latest.getDate())<exp){
    b.textContent=`‚ö†Ô∏è Bitte aktuelles Archiv hochladen ‚Äî es fehlen Ziehungen seit ${fmtD(latest)}. Erwartet bis: ${fmtD(exp)}.`; b.className='banner';
  }else{ b.textContent=`‚úÖ Archiv ist aktuell bis ${fmtD(latest)}.`; b.className='banner ok'; }
  b.classList.remove('hidden');
}

/* ====== Render & Export ====== */
const resultsEl=document.getElementById('results');
function renderBlock(title, fields){
  const wrap=document.createElement('div'); wrap.className='card';
  const h=document.createElement('h3'); h.textContent=title; wrap.appendChild(h);
  fields.forEach((f,i)=>{const div=document.createElement('div');div.className='card';
    const det=f.details?`<span class="badge">${f.details}</span>`:''; 
    div.innerHTML=`<b>Feld ${i+1}:</b> <span class="nums">${f.main.join(', ')}</span> <span class="badge">Euro: ${f.euro.join(', ')}</span>`+(f.points!=null?` <span class="badge ok">${f.points} Punkte</span>`:'')+det;
    wrap.appendChild(div);
  });
  resultsEl.prepend(wrap);
}
function setExport(title, fields){
  const rows=fields.map((f,i)=>({Feld:i+1,N1:f.main[0],N2:f.main[1],N3:f.main[2],N4:f.main[3],N5:f.main[4],E1:f.euro[0],E2:f.euro[1],Punkte:f.points??'',Details:f.details??''}));
  LAST_EXPORT={title, rows}; setExportBtns(true);
}
function setExportBtns(on){document.getElementById('btnCSV').disabled=!on; document.getElementById('btnXLSX').disabled=!on;}
document.getElementById('btnCSV').onclick=()=>{ if(!LAST_EXPORT) return; const header=Object.keys(LAST_EXPORT.rows[0]||{}); const csv=[header.join(';')].concat(LAST_EXPORT.rows.map(r=>header.map(k=>{const v=r[k]??'';const s=String(v).replace(/"/g,'""');return /[;"\n]/.test(s)?`"${s}"`:s;}).join(';'))).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=LAST_EXPORT.title+'.csv'; a.click(); };
document.getElementById('btnXLSX').onclick=()=>{ if(!LAST_EXPORT) return; const ws=XLSX.utils.json_to_sheet(LAST_EXPORT.rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ergebnisse'); XLSX.writeFile(wb, LAST_EXPORT.title+'.xlsx'); };

/* ====== Helpers ====== */
function sampleNoRep(n,min,max){const pool=[];for(let i=min;i<=max;i++)pool.push(i);for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]}return pool.slice(0,n).sort(byNum);}
function pickMain(){return sampleNoRep(5,1,50)} function pickEuro(){return sampleNoRep(2,1,12)}

/* ====== Noch nie gesehen ====== */
document.getElementById('btnNever').addEventListener('click', ()=>{
  if(!ARCH.length) return alert('Bitte erst Archiv hochladen.');
  const n=Math.max(1,Math.min(20,parseInt(document.getElementById('neverCount').value,10)||6));
  const out=[]; let guard=0;
  while(out.length<n && guard<15000){guard++; const main=pickMain(), euro=pickEuro(); if(!SEEN.has(key(main,euro))) out.push({main,euro});}
  if(!out.length) return alert('Kein neues Feld gefunden ‚Äì erneut versuchen.');
  renderBlock('Noch nie gesehen', out); setExport('NochNieGesehen', out);
});

/* ====== H√§ufige Paare ====== */
document.getElementById('btnPairs').addEventListener('click', ()=>{
  if(!ARCH.length) return alert('Bitte erst Archiv hochladen.');
  const k=parseInt(document.getElementById('pairsK').value,10);
  const topN=parseInt(document.getElementById('pairsTopN').value,10);
  const howMany=parseInt(document.getElementById('pairsCount').value,10);
  const yearsSel=selYears('pairsYears','pairsAll'); const data=filterYears(ARCH, yearsSel);
  if(!data.length) return alert('Keine Ziehungen im Zeitraum.');

  const pairMap=new Map();
  data.forEach(d=>{ for(let i=0;i<5;i++)for(let j=i+1;j<5;j++){const a=d.main[i],b=d.main[j];const kk=`${Math.min(a,b)}-${Math.max(a,b)}`;pairMap.set(kk,(pairMap.get(kk)||0)+1);} });
  const topPairs=Array.from(pairMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,topN).map(([k])=>k);
  const topSet=new Set(topPairs);

  const out=[]; let guard=0;
  while(out.length<howMany && guard<howMany*8000){
    guard++;
    const p1=topPairs[Math.floor(Math.random()*Math.min(20,topPairs.length))]||'';
    const p2=topPairs[Math.floor(Math.random()*Math.min(20,topPairs.length))]||'';
    const s=new Set(p1.split('-').map(Number).concat(p2.split('-').map(Number)).filter(x=>x));
    while(s.size<5) s.add(Math.floor(Math.random()*50)+1);
    const main=Array.from(s).slice(0,5).sort(byNum);
    const euro=pickEuro();
    let cnt=0; for(let i=0;i<5;i++)for(let j=i+1;j<5;j++){if(topSet.has(`${Math.min(main[i],main[j])}-${Math.max(main[i],main[j])}`)) cnt++;}
    if(cnt>=k){ out.push({main,euro,points:cnt}); }
  }
  if(!out.length) return alert('Nichts gefunden ‚Äì Top-N erh√∂hen oder k senken.');
  renderBlock(`H√§ufige Paare (‚â•${k}, Top-N ${topN})`, out); setExport('HaeufigePaare', out);
});

/* ====== Wahrscheinlichster Schein (Fenster-Scoring) ====== */
function scoreBasic(main,euro,fm,fe,topPairsSet){
  const sMain=main.reduce((s,v)=>s+(fm[v]||0),0);
  const sEuro=euro.reduce((s,v)=>s+(fe[v]||0),0)*0.5;
  let sPairs=0; for(let i=0;i<5;i++)for(let j=i+1;j<5;j++){if(topPairsSet.has(`${Math.min(main[i],main[j])}-${Math.max(main[i],main[j])}`)) sPairs+=5;}
  const even=main.filter(n=>n%2===0).length, low=main.filter(n=>n<=25).length;
  const patt=((even>=2&&even<=3)?4:0)+((low>=2&&low<=3)?4:0);
  return Math.round(sMain + sEuro + sPairs + patt);
}
document.getElementById('btnTop').addEventListener('click', ()=>{
  if(!ARCH.length) return alert('Bitte erst Archiv hochladen.');
  const n=Math.max(1,Math.min(20,parseInt(document.getElementById('topCount').value,10)||10));
  const yearsSel=selYears('topYears','topAll'); const data=filterYears(ARCH, yearsSel);
  if(!data.length) return alert('Keine Ziehungen im Zeitraum.');
  const fm=Array(51).fill(0), fe=Array(13).fill(0), pairMap=new Map();
  data.forEach(d=>{ d.main.forEach(x=>fm[x]++); d.euro.forEach(x=>fe[x]++); for(let i=0;i<5;i++)for(let j=i+1;j<5;j++){const a=d.main[i],b=d.main[j];const kk=`${Math.min(a,b)}-${Math.max(a,b)}`;pairMap.set(kk,(pairMap.get(kk)||0)+1);} });
  const topPairsSet=new Set(Array.from(pairMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,50).map(([k])=>k));
  const cands=[];
  for(let i=0;i<5000;i++){
    let main;
    if(Math.random()<0.4 && topPairsSet.size){
      const arr=Array.from(topPairsSet), p1=arr[Math.floor(Math.random()*Math.min(30,arr.length))], p2=arr[Math.floor(Math.random()*Math.min(30,arr.length))];
      const s=new Set(p1.split('-').map(Number).concat(p2.split('-').map(Number)));
      while(s.size<5) s.add(Math.floor(Math.random()*50)+1);
      main=Array.from(s).slice(0,5).sort(byNum);
    }else{
      const pool=Array.from({length:50},(_,i)=>i+1), w=pool.map(v=>fm[v]+1), pick=()=>{const t=w.reduce((a,b)=>a+b,0); let r=Math.random()*t,i=0; for(;i<w.length;i++){r-=w[i]; if(r<=0)break;} const v=pool[i]; w[i]=0; return v;};
      main=[pick(),pick(),pick(),pick(),pick()].sort(byNum);
    }
    const euro=(()=>{const pool=Array.from({length:12},(_,i)=>i+1), w=pool.map(v=>fe[v]+1), pick=()=>{const t=w.reduce((a,b)=>a+b,0); let r=Math.random()*t,i=0; for(;i<w.length;i++){r-=w[i]; if(r<=0)break;} const v=pool[i]; w[i]=0; return v;}; return [pick(),pick()].sort(byNum);})();
    const points=scoreBasic(main,euro,fm,fe,topPairsSet);
    cands.push({main,euro,points});
  }
  cands.sort((a,b)=>b.points-a.points);
  const best=cands.slice(0,n);
  renderBlock('Wahrscheinlichster Schein', best); setExport('TopSchein', best);
});

/* ====== Meta-Modus ====== */
document.getElementById('btnMeta').addEventListener('click', ()=>{
  if(!ARCH.length) return alert('Bitte erst Archiv hochladen.');
  const tickets=Math.max(1,Math.min(10,parseInt(document.getElementById('metaTickets').value,10)||2));
  const per=Math.max(1,Math.min(20,parseInt(document.getElementById('metaFields').value,10)||10));
  const avoid=document.getElementById('metaAvoidSeen').checked;

  // globale Top-Paare
  const pairMap=new Map();
  ARCH.forEach(d=>{ for(let i=0;i<5;i++)for(let j=i+1;j<5;j++){const a=d.main[i],b=d.main[j];const kk=`${Math.min(a,b)}-${Math.max(a,b)}`;pairMap.set(kk,(pairMap.get(kk)||0)+1);} });
  const pairArr=Array.from(pairMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,80).map(([k])=>k);

  const allFields=[];
  for(let t=0;t<tickets;t++){
    const picked=new Set();
    for(let i=0;i<per;i++){
      let f=null, guard=0;
      while(guard++<5000){
        const r=Math.random(); // Mix aus Strategien
        if(r<0.35 && pairArr.length){ // Paar-Anchor
          const p1=pairArr[Math.floor(Math.random()*Math.min(20,pairArr.length))], p2=pairArr[Math.floor(Math.random()*Math.min(20,pairArr.length))];
          const s=new Set(p1.split('-').map(Number).concat(p2.split('-').map(Number)));
          while(s.size<5) s.add(Math.floor(Math.random()*50)+1);
          f={main:Array.from(s).slice(0,5).sort(byNum), euro:pickEuro(), details:'Top-Paare'};
        }else if(r<0.7){ // Hot-Bias
          const w=[...MAIN], pool=Array.from({length:50},(_,i)=>i+1), pick=()=>{const tot=w.reduce((a,b)=>a+b,1); let rr=Math.random()*tot,idx=0; for(;idx<w.length;idx++){rr-=w[idx]; if(rr<=0)break;} const v=idx; w[idx]=0; return v;};
          const main=[pick(),pick(),pick(),pick(),pick()].filter(v=>v>0).sort(byNum);
          f={main, euro:pickEuro(), details:'Hot-Bias'};
        }else{ // Muster-Mix
          const m=pickMain(); const even=m.filter(n=>n%2===0).length; const low=m.filter(n=>n<=25).length;
          if(!(even>=2&&even<=3 && low>=2&&low<=3)) continue;
          f={main:m, euro:pickEuro(), details:'Muster'};
        }
        const k=key(f.main,f.euro); if(picked.has(k)) {f=null; continue;}
        if(avoid && SEEN.has(k)) {f=null; continue;}
        picked.add(k); break;
      }
      if(f){ allFields.push(f); }
    }
  }
  renderBlock(`Meta ‚Äî ${tickets} Schein(e) √ó ${per} Felder`, allFields); setExport('Meta', allFields);
});

/* ====== GOAT-Modus (Ensemble-Score) ====== */
document.getElementById('btnGoat').addEventListener('click', ()=>{
  if(!ARCH.length) return alert('Bitte erst Archiv hochladen.');
  const n=Math.max(1,Math.min(20,parseInt(document.getElementById('goatCount').value,10)||10));
  const poolSize=parseInt(document.getElementById('goatPool').value,10);
  const yearsSel=selYears('goatYears','goatAll'); const data=filterYears(ARCH, yearsSel);
  if(!data.length) return alert('Keine Ziehungen im Zeitraum.');

  // Recency-Gewichte (letzte Ziehungen z√§hlen st√§rker)
  const fm=Array(51).fill(0), fe=Array(13).fill(0), gap=Array(51).fill(0);
  const pairMap=new Map(), triMap=new Map();
  let lastSeen=Array(51).fill(-1), drawIdx=0;
  data.forEach(d=>{
    drawIdx++;
    const w=0.5+0.5*drawIdx/data.length; // linear (neuere Ziehungen h√∂her)
    d.main.forEach(x=>{fm[x]+=w;});
    d.euro.forEach(x=>{fe[x]+=w*0.7;});
    for(let i=0;i<5;i++) for(let j=i+1;j<5;j++){const a=d.main[i],b=d.main[j]; const k=`${Math.min(a,b)}-${Math.max(a,b)}`; pairMap.set(k,(pairMap.get(k)||0)+w);}
    for(let i=0;i<5;i++) for(let j=i+1;j<5;j++) for(let k=j+1;k<5;k++){const A=d.main[i],B=d.main[j],C=d.main[k]; const key=[A,B,C].sort(byNum).join('-'); triMap.set(key,(triMap.get(key)||0)+w*0.6);}
    // Gaps
    for(let n=1;n<=50;n++){ if(d.main.includes(n)){ gap[n]=0; lastSeen[n]=drawIdx; } else { gap[n]++; } }
  });
  const topPairsSet=new Set(Array.from(pairMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,80).map(([k])=>k));
  const topTripSet=new Set(Array.from(triMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,120).map(([k])=>k));

  // Kandidaten
  const cands=[];
  for(let i=0;i<poolSize;i++){
    // Start: Mischung aus Heuristiken
    let main;
    const r=Math.random();
    if(r<0.35 && topPairsSet.size){
      const arr=Array.from(topPairsSet); const p1=arr[Math.floor(Math.random()*Math.min(40,arr.length))], p2=arr[Math.floor(Math.random()*Math.min(40,arr.length))];
      const s=new Set(p1.split('-').map(Number).concat(p2.split('-').map(Number)));
      while(s.size<5) s.add(Math.floor(Math.random()*50)+1);
      main=Array.from(s).slice(0,5).sort(byNum);
    }else if(r<0.6 && topTripSet.size){
      const arr=Array.from(topTripSet); const t1=arr[Math.floor(Math.random()*Math.min(60,arr.length))];
      const s=new Set(t1.split('-').map(Number));
      while(s.size<5) s.add(Math.floor(Math.random()*50)+1);
      main=Array.from(s).slice(0,5).sort(byNum);
    }else{
      // gewichtete Auswahl nach Recency-Frequenz + Gap-Bonus
      const weight=n=>fm[n]+(gap[n]>10?0.3*gap[n]:0);
      const pool=Array.from({length:50},(_,i)=>i+1), w=pool.map(v=>weight(v)+1e-6), pick=()=>{const t=w.reduce((a,b)=>a+b,0); let rr=Math.random()*t,idx=0; for(;idx<w.length;idx++){rr-=w[idx]; if(rr<=0)break;} const v=pool[idx]; w[idx]=0; return v;};
      main=[pick(),pick(),pick(),pick(),pick()].sort(byNum);
    }
    const euro=(()=>{const pool=Array.from({length:12},(_,i)=>i+1), w=pool.map(v=>fe[v]+1e-6), pick=()=>{const t=w.reduce((a,b)=>a+b,0); let r=Math.random()*t,i=0; for(;i<w.length;i++){r-=w[i]; if(r<=0)break;} const v=pool[i]; w[i]=0; return v;}; return [pick(),pick()].sort(byNum);})();

    // Ensemble-Score
    const sMain=main.reduce((s,v)=>s+(fm[v]||0),0);
    const sEuro=euro.reduce((s,v)=>s+(fe[v]||0),0)*0.6;
    let sPairs=0; for(let i=0;i<5;i++)for(let j=i+1;j<5;j++){if(topPairsSet.has(`${Math.min(main[i],main[j])}-${Math.max(main[i],main[j])}`)) sPairs+=4;}
    let sTrip=0; {const key3=main.slice().sort(byNum).join('-'); if(topTripSet.has(key3)) sTrip+=6;}
    const even=main.filter(n=>n%2===0).length, low=main.filter(n=>n<=25).length;
    const patt=((even>=2&&even<=3)?5:0)+((low>=2&&low<=3)?5:0);
    const spread=(main[4]-main[0]); const spreadScore= (spread>=20 && spread<=40)?4:0;
    const seenPenalty= SEEN.has(key(main,euro)) ? -25 : 0;
    const score=Math.round(sMain + sEuro + sPairs + sTrip + patt + spreadScore + seenPenalty);
    cands.push({main,euro,points:score,details:`even:${even}/low:${low}/spread:${spread}`});
  }
  cands.sort((a,b)=>b.points-a.points);

  // Entkopple √§hnliche Felder (mind. 2 andere Hauptzahlen)
  const best=[]; outer: for(const c of cands){ if(best.length>=n) break; for(const b of best){ let same=0; for(const x of c.main){ if(b.main.includes(x)) same++; } if(same>=3) continue outer; } best.push(c); }

  renderBlock('GOAT-Felder', best); setExport('GOAT', best);
});
</script>
</body>
</html>